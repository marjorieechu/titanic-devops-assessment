name: CI/CD Pipeline

on:
  push:
    branches: 
        - "**"
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  COVERAGE_THRESHOLD: 70

jobs:
  # ==========================================
  # STAGE 1: SECRET DETECTION (Gate)
  # ==========================================

  secrets-scan:
    name: "Stage 1: Gitleaks Secrets Scan"
    uses: marjorieechu/shared-gh-workflows/.github/workflows/gitleaks.yml@main
    with:
      fail_on_leak: true

  # ==========================================
  # STAGE 2: IAC SECURITY SCAN (Gate)
  # ==========================================

  iac-scan:
    name: "Stage 2: Checkov IaC Scan"
    needs: [secrets-scan]
    uses: marjorieechu/shared-gh-workflows/.github/workflows/checkov.yml@main
    with:
      directory: '.'
      framework: 'all'
      soft_fail: false

  # # ==========================================
  # # STAGE 3: UNIT TESTS, LINTING & COVERAGE
  # # ==========================================

  # test:
  #   name: "Stage 3: Unit Tests & Lint"
  #   runs-on: ubuntu-latest
  #   needs: [iac-scan]
  #   outputs:
  #     coverage: ${{ steps.coverage.outputs.coverage }}
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'
  #         cache: 'pip'

  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -r app/requirements.txt
  #         pip install pytest pytest-cov flake8 black

  #     - name: Lint with flake8
  #       run: flake8 app --count --select=E9,F63,F7,F82 --show-source --statistics

  #     - name: Check formatting with black
  #       run: black --check app

  #     - name: Run tests with coverage
  #       id: coverage
  #       run: |
  #         pytest app/tests/ -v --cov=app --cov-report=xml --cov-report=html --cov-report=term --cov-fail-under=${{ env.COVERAGE_THRESHOLD }}
  #         COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); print(round(float(tree.getroot().attrib['line-rate']) * 100, 2))")
  #         echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
  #         echo "### Coverage Report" >> $GITHUB_STEP_SUMMARY
  #         echo "Coverage: $COVERAGE%" >> $GITHUB_STEP_SUMMARY

  #     - name: Upload coverage report
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: coverage-report
  #         path: |
  #           htmlcov/
  #           coverage.xml
  #         retention-days: 14

  # # ==========================================
  # # STAGE 4: CODE QUALITY & SAST (Gate)
  # # ==========================================

  # code-quality:
  #   name: "Stage 4: SonarCloud Analysis"
  #   needs: [test]
  #   uses: marjorieechu/shared-gh-workflows/.github/workflows/sonarcloud.yml@main
  #   with:
  #     project_key: 'marjorieechu_titanic-devops-assessment'
  #     organization: 'marjorieechu'
  #     sources: 'app'
  #   secrets:
  #     sonar_token: ${{ secrets.SONAR_TOKEN }}

  # ==========================================
  # STAGE 5: BUILD & PUSH DOCKER IMAGE
  # ==========================================

  build:
    name: "Stage 5: Build & Push Image"
    runs-on: ubuntu-latest
    # needs: [code-quality]
    needs: [iac-scan]
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_version: ${{ steps.meta.outputs.version }}
      image_digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=

      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate build summary
        run: |
          echo "### Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags:** ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest:** ${{ steps.build.outputs.digest }}" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # STAGE 6: SCAN BUILT IMAGE
  # ==========================================

  image-scan:
    name: "Stage 6: Trivy Image Scan"
    needs: [build]
    if: github.event_name != 'pull_request'
    uses: marjorieechu/shared-gh-workflows/.github/workflows/trivy.yml@main
    with:
      scan_type: 'image'
      image_ref: ghcr.io/${{ github.repository }}:sha-${{ github.sha }}
      severity: 'CRITICAL,HIGH'
      exit_code: 1

  # ==========================================
  # STAGE 7: DEPLOY TO ENVIRONMENTS
  # ==========================================

  deploy-dev:
    name: "Stage 7a: Deploy to Dev"
    runs-on: ubuntu-latest
    needs: [image-scan]
    if: github.ref == 'refs/heads/develop'
    environment:
      name: development
      url: https://dev.titanic-api.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure Kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Deploy to Dev Kubernetes
        id: deploy
        run: |
          echo "Deploying to development environment..."
          echo "Image: ghcr.io/${{ github.repository }}:sha-${{ github.sha }}"
          kubectl set image deployment/titanic-api titanic-api=ghcr.io/${{ github.repository }}:sha-${{ github.sha }} -n dev
          kubectl rollout status deployment/titanic-api -n dev --timeout=300s

      - name: Notify Slack - Dev Deploy
        if: always()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "${{ job.status == 'success' && '‚úÖ' || '‚ùå' }} Dev Deployment ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Dev Deployment ${{ job.status }}*\n‚Ä¢ Repo: ${{ github.repository }}\n‚Ä¢ Branch: ${{ github.ref_name }}\n‚Ä¢ Commit: ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true

  deploy-staging:
    name: "Stage 7b: Deploy to Staging"
    runs-on: ubuntu-latest
    needs: [image-scan]
    if: github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://staging.titanic-api.example.com
    outputs:
      deployment_id: ${{ steps.deploy.outputs.deployment_id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure Kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Deploy to Staging Kubernetes
        id: deploy
        run: |
          echo "Deploying to staging environment..."
          echo "Image: ghcr.io/${{ github.repository }}:sha-${{ github.sha }}"
          kubectl set image deployment/titanic-api titanic-api=ghcr.io/${{ github.repository }}:sha-${{ github.sha }} -n staging
          kubectl rollout status deployment/titanic-api -n staging --timeout=300s
          echo "deployment_id=${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: Notify Slack - Staging Deploy
        if: always()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "${{ job.status == 'success' && '‚úÖ' || '‚ùå' }} Staging Deployment ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Staging Deployment ${{ job.status }}*\n‚Ä¢ Repo: ${{ github.repository }}\n‚Ä¢ Branch: ${{ github.ref_name }}\n‚Ä¢ Commit: ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true

  deploy-prod:
    name: "Stage 7c: Deploy to Production"
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://titanic-api.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure Kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Get current deployment revision
        id: current
        run: |
          CURRENT_REVISION=$(kubectl rollout history deployment/titanic-api -n prod | tail -2 | head -1 | awk '{print $1}')
          echo "revision=$CURRENT_REVISION" >> $GITHUB_OUTPUT

      - name: Deploy to Production Kubernetes
        id: deploy
        run: |
          echo "Deploying to production environment..."
          echo "Image: ghcr.io/${{ github.repository }}:sha-${{ github.sha }}"
          kubectl set image deployment/titanic-api titanic-api=ghcr.io/${{ github.repository }}:sha-${{ github.sha }} -n prod
          kubectl rollout status deployment/titanic-api -n prod --timeout=300s

      - name: Verify deployment health
        id: health
        run: |
          echo "Verifying deployment health..."
          sleep 30
          HEALTHY=$(kubectl get pods -n prod -l app=titanic-api -o jsonpath='{.items[*].status.phase}' | grep -c Running || echo 0)
          if [ "$HEALTHY" -lt 1 ]; then
            echo "health_check=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "health_check=passed" >> $GITHUB_OUTPUT

      - name: Rollback on failure
        if: failure() && steps.deploy.outcome == 'success'
        run: |
          echo "Deployment failed health checks, rolling back..."
          kubectl rollout undo deployment/titanic-api -n prod --to-revision=${{ steps.current.outputs.revision }}
          kubectl rollout status deployment/titanic-api -n prod --timeout=300s
          echo "Rollback completed to revision ${{ steps.current.outputs.revision }}"

      - name: Notify Slack - Production Deploy
        if: always()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "${{ job.status == 'success' && 'üöÄ ‚úÖ' || 'üö® ‚ùå' }} Production Deployment ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment ${{ job.status }}*\n‚Ä¢ Repo: ${{ github.repository }}\n‚Ä¢ Branch: ${{ github.ref_name }}\n‚Ä¢ Commit: `${{ github.sha }}`\n‚Ä¢ Actor: ${{ github.actor }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "View Run" },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true
